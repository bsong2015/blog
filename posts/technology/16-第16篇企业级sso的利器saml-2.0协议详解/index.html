<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>万年水的博客</title><meta name=keywords content><meta name=description content="第16篇：企业级SSO的利器SAML 2.0协议详解
在上一篇文章中，我们深入探讨了OpenID Connect (OIDC) 如何在OAuth 2.0之上构建身份认证层，成为现代互联网和移动应用SSO的主流选择。然而，在企业级应用和组织间协作的场景中，尤其是一些传统或遗留系统，你可能更常听到另一个强大的SSO协议——SAML 2.0 (Security Assertion Markup Language)。
SAML 2.0是基于XML的开放标准，专门用于在不同安全域之间安全地交换认证和授权数据。它在企业级SSO领域扮演着举足轻重的角色，是许多大型企业内部应用以及企业与云服务（如Salesforce、Microsoft 365等）进行身份联邦的基石。
1. SAML 2.0的核心概念：信任的桥梁
SAML 2.0的核心在于构建一个信任联盟（Trust Federation），允许用户在一个信任域（通常是企业内部）完成认证后，无需重复登录即可访问另一个信任域（例如，一个外部SaaS应用）的资源。理解其核心概念是掌握SAML的关键。
1.1 身份提供者（Identity Provider, IdP）

定义： IdP是负责认证用户身份并生成SAML断言的实体。它就像一个“数字护照签发机构”。
职责：

接收用户的认证请求（例如，登录页面的用户名密码）。
验证用户凭证。
成功认证后，生成一个包含用户身份和属性信息的SAML断言（Assertion），并对其进行数字签名。
将SAML断言发送给服务提供者（SP）。


常见示例： 企业内部的Active Directory Federation Services (AD FS)、Okta、PingFederate、Azure AD等。

1.2 服务提供者（Service Provider, SP）

定义： SP是提供具体应用服务并依赖IdP进行用户认证的实体。它就像一个“边境检查站”，接收并验证数字护照。
职责：

接收用户的访问请求。
检测用户是否已认证。如果未认证，将用户重定向到IdP。
接收来自IdP的SAML断言。
验证SAML断言的有效性（包括签名、时间戳、受众等）。
根据断言中的用户身份信息，创建本地会话并允许用户访问应用。


常见示例： Salesforce、Microsoft 365、Workday、各种企业内部Web应用。

1.3 SAML 断言（SAML Assertion）

定义： SAML断言是SAML协议的核心，它是一个XML文档，包含了由IdP生成的关于用户身份和认证事件的声明（Statements）。它就像一份数字化的“身份证明”或“通行证”。
核心信息：

认证声明（Authentication Statement）： 声明了用户何时、何地以及如何被IdP认证。
属性声明（Attribute Statement）： 包含了用户的各种属性信息（Attributes），如姓名、邮箱、部门、角色等。这些属性可以用于SP进行授权决策或填充用户档案。
授权决策声明（Authorization Decision Statement）： 较少使用，可用于声明IdP对特定资源或操作的授权决策。


安全性： SAML断言必须由IdP进行数字签名，以确保其完整性和真实性，防止篡改。SP会使用IdP的公共证书来验证此签名。断言通常也会被加密传输。

2. SAML 2.0的两种主要工作流程
SAML 2.0主要定义了两种用户启动SSO的流程，它们决定了用户在未登录时首先访问哪一方。"><meta name=author content><link rel=canonical href=https://bsong2015.github.io/blog/posts/technology/16-%E7%AC%AC16%E7%AF%87%E4%BC%81%E4%B8%9A%E7%BA%A7sso%E7%9A%84%E5%88%A9%E5%99%A8saml-2.0%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://bsong2015.github.io/blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://bsong2015.github.io/blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://bsong2015.github.io/blog/favicon-32x32.png><link rel=apple-touch-icon href=https://bsong2015.github.io/blog/apple-touch-icon.png><link rel=mask-icon href=https://bsong2015.github.io/blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://bsong2015.github.io/blog/posts/technology/16-%E7%AC%AC16%E7%AF%87%E4%BC%81%E4%B8%9A%E7%BA%A7sso%E7%9A%84%E5%88%A9%E5%99%A8saml-2.0%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://bsong2015.github.io/blog/posts/technology/16-%E7%AC%AC16%E7%AF%87%E4%BC%81%E4%B8%9A%E7%BA%A7sso%E7%9A%84%E5%88%A9%E5%99%A8saml-2.0%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/"><meta property="og:site_name" content="万年水的博客"><meta property="og:title" content="万年水的博客"><meta property="og:description" content="第16篇：企业级SSO的利器SAML 2.0协议详解 在上一篇文章中，我们深入探讨了OpenID Connect (OIDC) 如何在OAuth 2.0之上构建身份认证层，成为现代互联网和移动应用SSO的主流选择。然而，在企业级应用和组织间协作的场景中，尤其是一些传统或遗留系统，你可能更常听到另一个强大的SSO协议——SAML 2.0 (Security Assertion Markup Language)。
SAML 2.0是基于XML的开放标准，专门用于在不同安全域之间安全地交换认证和授权数据。它在企业级SSO领域扮演着举足轻重的角色，是许多大型企业内部应用以及企业与云服务（如Salesforce、Microsoft 365等）进行身份联邦的基石。
1. SAML 2.0的核心概念：信任的桥梁 SAML 2.0的核心在于构建一个信任联盟（Trust Federation），允许用户在一个信任域（通常是企业内部）完成认证后，无需重复登录即可访问另一个信任域（例如，一个外部SaaS应用）的资源。理解其核心概念是掌握SAML的关键。
1.1 身份提供者（Identity Provider, IdP） 定义： IdP是负责认证用户身份并生成SAML断言的实体。它就像一个“数字护照签发机构”。 职责： 接收用户的认证请求（例如，登录页面的用户名密码）。 验证用户凭证。 成功认证后，生成一个包含用户身份和属性信息的SAML断言（Assertion），并对其进行数字签名。 将SAML断言发送给服务提供者（SP）。 常见示例： 企业内部的Active Directory Federation Services (AD FS)、Okta、PingFederate、Azure AD等。 1.2 服务提供者（Service Provider, SP） 定义： SP是提供具体应用服务并依赖IdP进行用户认证的实体。它就像一个“边境检查站”，接收并验证数字护照。 职责： 接收用户的访问请求。 检测用户是否已认证。如果未认证，将用户重定向到IdP。 接收来自IdP的SAML断言。 验证SAML断言的有效性（包括签名、时间戳、受众等）。 根据断言中的用户身份信息，创建本地会话并允许用户访问应用。 常见示例： Salesforce、Microsoft 365、Workday、各种企业内部Web应用。 1.3 SAML 断言（SAML Assertion） 定义： SAML断言是SAML协议的核心，它是一个XML文档，包含了由IdP生成的关于用户身份和认证事件的声明（Statements）。它就像一份数字化的“身份证明”或“通行证”。 核心信息： 认证声明（Authentication Statement）： 声明了用户何时、何地以及如何被IdP认证。 属性声明（Attribute Statement）： 包含了用户的各种属性信息（Attributes），如姓名、邮箱、部门、角色等。这些属性可以用于SP进行授权决策或填充用户档案。 授权决策声明（Authorization Decision Statement）： 较少使用，可用于声明IdP对特定资源或操作的授权决策。 安全性： SAML断言必须由IdP进行数字签名，以确保其完整性和真实性，防止篡改。SP会使用IdP的公共证书来验证此签名。断言通常也会被加密传输。 2. SAML 2.0的两种主要工作流程 SAML 2.0主要定义了两种用户启动SSO的流程，它们决定了用户在未登录时首先访问哪一方。"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="第16篇：企业级SSO的利器SAML 2.0协议详解
在上一篇文章中，我们深入探讨了OpenID Connect (OIDC) 如何在OAuth 2.0之上构建身份认证层，成为现代互联网和移动应用SSO的主流选择。然而，在企业级应用和组织间协作的场景中，尤其是一些传统或遗留系统，你可能更常听到另一个强大的SSO协议——SAML 2.0 (Security Assertion Markup Language)。
SAML 2.0是基于XML的开放标准，专门用于在不同安全域之间安全地交换认证和授权数据。它在企业级SSO领域扮演着举足轻重的角色，是许多大型企业内部应用以及企业与云服务（如Salesforce、Microsoft 365等）进行身份联邦的基石。
1. SAML 2.0的核心概念：信任的桥梁
SAML 2.0的核心在于构建一个信任联盟（Trust Federation），允许用户在一个信任域（通常是企业内部）完成认证后，无需重复登录即可访问另一个信任域（例如，一个外部SaaS应用）的资源。理解其核心概念是掌握SAML的关键。
1.1 身份提供者（Identity Provider, IdP）

定义： IdP是负责认证用户身份并生成SAML断言的实体。它就像一个“数字护照签发机构”。
职责：

接收用户的认证请求（例如，登录页面的用户名密码）。
验证用户凭证。
成功认证后，生成一个包含用户身份和属性信息的SAML断言（Assertion），并对其进行数字签名。
将SAML断言发送给服务提供者（SP）。


常见示例： 企业内部的Active Directory Federation Services (AD FS)、Okta、PingFederate、Azure AD等。

1.2 服务提供者（Service Provider, SP）

定义： SP是提供具体应用服务并依赖IdP进行用户认证的实体。它就像一个“边境检查站”，接收并验证数字护照。
职责：

接收用户的访问请求。
检测用户是否已认证。如果未认证，将用户重定向到IdP。
接收来自IdP的SAML断言。
验证SAML断言的有效性（包括签名、时间戳、受众等）。
根据断言中的用户身份信息，创建本地会话并允许用户访问应用。


常见示例： Salesforce、Microsoft 365、Workday、各种企业内部Web应用。

1.3 SAML 断言（SAML Assertion）

定义： SAML断言是SAML协议的核心，它是一个XML文档，包含了由IdP生成的关于用户身份和认证事件的声明（Statements）。它就像一份数字化的“身份证明”或“通行证”。
核心信息：

认证声明（Authentication Statement）： 声明了用户何时、何地以及如何被IdP认证。
属性声明（Attribute Statement）： 包含了用户的各种属性信息（Attributes），如姓名、邮箱、部门、角色等。这些属性可以用于SP进行授权决策或填充用户档案。
授权决策声明（Authorization Decision Statement）： 较少使用，可用于声明IdP对特定资源或操作的授权决策。


安全性： SAML断言必须由IdP进行数字签名，以确保其完整性和真实性，防止篡改。SP会使用IdP的公共证书来验证此签名。断言通常也会被加密传输。

2. SAML 2.0的两种主要工作流程
SAML 2.0主要定义了两种用户启动SSO的流程，它们决定了用户在未登录时首先访问哪一方。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://bsong2015.github.io/blog/posts/"},{"@type":"ListItem","position":2,"name":"技术实践","item":"https://bsong2015.github.io/blog/posts/technology/"},{"@type":"ListItem","position":3,"name":"","item":"https://bsong2015.github.io/blog/posts/technology/16-%E7%AC%AC16%E7%AF%87%E4%BC%81%E4%B8%9A%E7%BA%A7sso%E7%9A%84%E5%88%A9%E5%99%A8saml-2.0%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"","name":"","description":"第16篇：企业级SSO的利器SAML 2.0协议详解 在上一篇文章中，我们深入探讨了OpenID Connect (OIDC) 如何在OAuth 2.0之上构建身份认证层，成为现代互联网和移动应用SSO的主流选择。然而，在企业级应用和组织间协作的场景中，尤其是一些传统或遗留系统，你可能更常听到另一个强大的SSO协议——SAML 2.0 (Security Assertion Markup Language)。\nSAML 2.0是基于XML的开放标准，专门用于在不同安全域之间安全地交换认证和授权数据。它在企业级SSO领域扮演着举足轻重的角色，是许多大型企业内部应用以及企业与云服务（如Salesforce、Microsoft 365等）进行身份联邦的基石。\n1. SAML 2.0的核心概念：信任的桥梁 SAML 2.0的核心在于构建一个信任联盟（Trust Federation），允许用户在一个信任域（通常是企业内部）完成认证后，无需重复登录即可访问另一个信任域（例如，一个外部SaaS应用）的资源。理解其核心概念是掌握SAML的关键。\n1.1 身份提供者（Identity Provider, IdP） 定义： IdP是负责认证用户身份并生成SAML断言的实体。它就像一个“数字护照签发机构”。 职责： 接收用户的认证请求（例如，登录页面的用户名密码）。 验证用户凭证。 成功认证后，生成一个包含用户身份和属性信息的SAML断言（Assertion），并对其进行数字签名。 将SAML断言发送给服务提供者（SP）。 常见示例： 企业内部的Active Directory Federation Services (AD FS)、Okta、PingFederate、Azure AD等。 1.2 服务提供者（Service Provider, SP） 定义： SP是提供具体应用服务并依赖IdP进行用户认证的实体。它就像一个“边境检查站”，接收并验证数字护照。 职责： 接收用户的访问请求。 检测用户是否已认证。如果未认证，将用户重定向到IdP。 接收来自IdP的SAML断言。 验证SAML断言的有效性（包括签名、时间戳、受众等）。 根据断言中的用户身份信息，创建本地会话并允许用户访问应用。 常见示例： Salesforce、Microsoft 365、Workday、各种企业内部Web应用。 1.3 SAML 断言（SAML Assertion） 定义： SAML断言是SAML协议的核心，它是一个XML文档，包含了由IdP生成的关于用户身份和认证事件的声明（Statements）。它就像一份数字化的“身份证明”或“通行证”。 核心信息： 认证声明（Authentication Statement）： 声明了用户何时、何地以及如何被IdP认证。 属性声明（Attribute Statement）： 包含了用户的各种属性信息（Attributes），如姓名、邮箱、部门、角色等。这些属性可以用于SP进行授权决策或填充用户档案。 授权决策声明（Authorization Decision Statement）： 较少使用，可用于声明IdP对特定资源或操作的授权决策。 安全性： SAML断言必须由IdP进行数字签名，以确保其完整性和真实性，防止篡改。SP会使用IdP的公共证书来验证此签名。断言通常也会被加密传输。 2. SAML 2.0的两种主要工作流程 SAML 2.0主要定义了两种用户启动SSO的流程，它们决定了用户在未登录时首先访问哪一方。\n","keywords":[],"articleBody":"第16篇：企业级SSO的利器SAML 2.0协议详解 在上一篇文章中，我们深入探讨了OpenID Connect (OIDC) 如何在OAuth 2.0之上构建身份认证层，成为现代互联网和移动应用SSO的主流选择。然而，在企业级应用和组织间协作的场景中，尤其是一些传统或遗留系统，你可能更常听到另一个强大的SSO协议——SAML 2.0 (Security Assertion Markup Language)。\nSAML 2.0是基于XML的开放标准，专门用于在不同安全域之间安全地交换认证和授权数据。它在企业级SSO领域扮演着举足轻重的角色，是许多大型企业内部应用以及企业与云服务（如Salesforce、Microsoft 365等）进行身份联邦的基石。\n1. SAML 2.0的核心概念：信任的桥梁 SAML 2.0的核心在于构建一个信任联盟（Trust Federation），允许用户在一个信任域（通常是企业内部）完成认证后，无需重复登录即可访问另一个信任域（例如，一个外部SaaS应用）的资源。理解其核心概念是掌握SAML的关键。\n1.1 身份提供者（Identity Provider, IdP） 定义： IdP是负责认证用户身份并生成SAML断言的实体。它就像一个“数字护照签发机构”。 职责： 接收用户的认证请求（例如，登录页面的用户名密码）。 验证用户凭证。 成功认证后，生成一个包含用户身份和属性信息的SAML断言（Assertion），并对其进行数字签名。 将SAML断言发送给服务提供者（SP）。 常见示例： 企业内部的Active Directory Federation Services (AD FS)、Okta、PingFederate、Azure AD等。 1.2 服务提供者（Service Provider, SP） 定义： SP是提供具体应用服务并依赖IdP进行用户认证的实体。它就像一个“边境检查站”，接收并验证数字护照。 职责： 接收用户的访问请求。 检测用户是否已认证。如果未认证，将用户重定向到IdP。 接收来自IdP的SAML断言。 验证SAML断言的有效性（包括签名、时间戳、受众等）。 根据断言中的用户身份信息，创建本地会话并允许用户访问应用。 常见示例： Salesforce、Microsoft 365、Workday、各种企业内部Web应用。 1.3 SAML 断言（SAML Assertion） 定义： SAML断言是SAML协议的核心，它是一个XML文档，包含了由IdP生成的关于用户身份和认证事件的声明（Statements）。它就像一份数字化的“身份证明”或“通行证”。 核心信息： 认证声明（Authentication Statement）： 声明了用户何时、何地以及如何被IdP认证。 属性声明（Attribute Statement）： 包含了用户的各种属性信息（Attributes），如姓名、邮箱、部门、角色等。这些属性可以用于SP进行授权决策或填充用户档案。 授权决策声明（Authorization Decision Statement）： 较少使用，可用于声明IdP对特定资源或操作的授权决策。 安全性： SAML断言必须由IdP进行数字签名，以确保其完整性和真实性，防止篡改。SP会使用IdP的公共证书来验证此签名。断言通常也会被加密传输。 2. SAML 2.0的两种主要工作流程 SAML 2.0主要定义了两种用户启动SSO的流程，它们决定了用户在未登录时首先访问哪一方。\n2.1 SP-Initiated SSO（服务提供者发起） 这是最常见的SAML SSO流程，用户通常从尝试访问某个SP的应用开始。\n用户尝试访问SP资源： 用户通过浏览器访问SP上的一个受保护资源。 SP发起认证请求： SP发现用户未登录，生成一个SAML认证请求（AuthnRequest，XML格式），并将其编码后（通常是Base64编码）通过HTTP重定向（GET）或HTTP POST（表单提交）方式，将用户浏览器重定向到IdP的SSO端点，请求用户认证。 HTTP Redirect Binding： AuthnRequest被压缩、Base64编码后放入URL参数。适用于较小的请求。 HTTP POST Binding： AuthnRequest被Base64编码后放入一个HTML表单的隐藏字段，表单自动提交到IdP。 用户在IdP认证： 用户浏览器被重定向到IdP的登录页面。用户在此处输入凭证（用户名/密码，可能还有MFA）进行认证。 IdP生成并返回SAML响应： IdP验证用户凭证成功后，生成一个包含认证信息和用户属性的SAML响应（Response，XML格式，内含SAML断言），并对其进行数字签名。然后，IdP将这个SAML响应编码后（通常是Base64编码）通过HTTP POST（自动提交的HTML表单）方式，将用户浏览器重定向回SP的Assertion Consumer Service (ACS) 端点。 SP验证SAML响应并建立会话： SP的ACS端点接收SAML响应，验证其数字签名、断言的有效性（如时间戳、受众等），并从断言中提取用户身份和属性信息。 SP授予访问权限： SP根据验证通过的SAML断言为用户创建本地会话，并允许用户访问请求的资源。 sequenceDiagram participant User participant SP participant IdP User-\u003e\u003eSP: 1. 尝试访问受保护资源 SP-\u003e\u003eUser: 2. 发起认证请求 (HTTP Redirect/POST with AuthnRequest) User-\u003e\u003eIdP: 2. 浏览器重定向到IdP SSO端点 activate IdP IdP--\u003e\u003eUser: 3. 显示登录页面 User-\u003e\u003eIdP: 3. 输入凭证并认证 deactivate IdP IdP-\u003e\u003eUser: 4. 返回SAML响应 (HTTP POST with SAMLResponse) User-\u003e\u003eSP: 4. 浏览器重定向到SP ACS端点 activate SP SP-\u003e\u003eSP: 5. 验证SAML响应并建立会话 SP--\u003e\u003eUser: 6. 授予访问权限，访问请求资源 deactivate SP 2.2 IdP-Initiated SSO（身份提供者发起） 这种流程相对简单，用户通常从IdP的门户网站登录开始。\n用户在IdP门户登录： 用户直接访问IdP的门户（例如，企业内部员工门户）并在此处登录。 IdP生成并发送SAML响应： IdP认证用户成功后，用户可以选择访问某个已集成的SP应用。IdP会立即生成一个包含用户身份和属性信息的SAML响应（Response，XML格式，内含SAML断言），并对其进行数字签名。然后，IdP将这个SAML响应编码后（通常是Base64编码）通过HTTP POST方式，将用户浏览器重定向到指定SP的ACS端点。 SP验证SAML响应并建立会话： SP的ACS端点接收SAML响应，验证其有效性并提取用户信息。 SP授予访问权限： SP根据验证通过的SAML断言为用户创建本地会话，并允许用户访问应用。 sequenceDiagram participant User participant IdP participant SP User-\u003e\u003eIdP: 1. 访问IdP门户并登录 activate IdP IdP--\u003e\u003eUser: 1. 显示已认证的IdP门户 User-\u003e\u003eIdP: 2. 选择访问某个SP应用 IdP-\u003e\u003eUser: 2. 生成并发送SAML响应 (HTTP POST with SAMLResponse) deactivate IdP User-\u003e\u003eSP: 2. 浏览器重定向到SP ACS端点 activate SP SP-\u003e\u003eSP: 3. 验证SAML响应并建立会话 SP--\u003e\u003eUser: 4. 授予访问权限，访问应用 deactivate SP 对比： SP-Initiated SSO更常见，因为它允许用户从任何一个SP应用启动登录，用户体验更自然。IdP-Initiated SSO则适合从企业内部统一门户访问所有应用的场景。 3. SAML 2.0的绑定（Bindings）：传输SAML消息的方式 SAML 2.0定义了多种“绑定”（Bindings），它们描述了SAML消息（如AuthnRequest和Response）如何在不同的传输协议（如HTTP）上进行交换。最常用的两种是：\n3.1 HTTP Redirect Binding 原理： SAML消息（如AuthnRequest）会被压缩并进行Base64编码，然后作为URL查询参数附加到HTTP重定向（GET请求）中。 特点： 简单，广泛支持。 URL长度有限制，不适合传输大的SAML消息。 消息内容暴露在URL中（尽管编码了，但并非加密），不适合传输敏感信息。 适用场景： 通常用于SP向IdP发送AuthnRequest，因为请求通常较小。 3.2 HTTP POST Binding 原理： SAML消息会被Base64编码，然后作为隐藏的表单字段（SAMLRequest或SAMLResponse）放置在一个HTML表单中，并通过HTTP POST方法自动提交到目标URL。 特点： 没有URL长度限制，可以传输更大的SAML消息。 消息内容不会直接暴露在URL中。 是SAML响应（Response）最常用的传输方式，因为它包含敏感的认证断言。 适用场景： IdP向SP发送SAMLResponse，以及一些SP发送AuthnRequest的场景。 除了上述两种，还有SOAP Binding（通过SOAP协议传输）等，但HTTP POST和HTTP Redirect是最普遍使用的。 所有的SAML通信都应该在HTTPS/TLS加密通道上进行，以保护传输中的敏感数据。\n总结 SAML 2.0作为一个成熟且广泛采纳的企业级SSO协议，通过定义IdP、SP和SAML断言等核心概念，以及SP-Initiated和IdP-Initiated两种主要工作流程，实现了不同安全域之间的身份联邦。其基于XML和数字签名的特性，使其在安全性和互操作性方面表现出色，成为连接企业内部系统与外部云服务的强大工具。\n尽管其配置和实现可能比OIDC更为复杂，但SAML 2.0在传统企业和大型组织架构中仍然扮演着不可替代的角色。理解SAML 2.0的工作原理和最佳实践，是构建复杂IAM和身份联邦解决方案的关键能力。\n欢迎关注+点赞+推荐+转发\n","wordCount":"262","inLanguage":"zh","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://bsong2015.github.io/blog/posts/technology/16-%E7%AC%AC16%E7%AF%87%E4%BC%81%E4%B8%9A%E7%BA%A7sso%E7%9A%84%E5%88%A9%E5%99%A8saml-2.0%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/"},"publisher":{"@type":"Organization","name":"万年水的博客","logo":{"@type":"ImageObject","url":"https://bsong2015.github.io/blog/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://bsong2015.github.io/blog/ accesskey=h title="万年水的博客 (Alt + H)">万年水的博客</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://bsong2015.github.io/blog/posts/artificial-intelligence/ title=人工智能><span>人工智能</span></a></li><li><a href=https://bsong2015.github.io/blog/posts/reading/ title=阅读><span>阅读</span></a></li><li><a href=https://bsong2015.github.io/blog/posts/thinking-models/ title=思维模型><span>思维模型</span></a></li><li><a href=https://bsong2015.github.io/blog/posts/thought-experiments/ title=思想实验><span>思想实验</span></a></li><li><a href=https://bsong2015.github.io/blog/posts/personal-growth/ title=个人成长><span>个人成长</span></a></li><li><a href=https://bsong2015.github.io/blog/posts/technology/ title=技术><span>技术</span></a></li><li><a href=https://bsong2015.github.io/blog/posts/current-affairs/ title=时事><span>时事</span></a></li><li><a href=https://bsong2015.github.io/blog/posts/others/ title=其它><span>其它</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent"></h1><div class=post-meta></div></header><div class=post-content><h2 id=第16篇企业级sso的利器saml-20协议详解>第16篇：企业级SSO的利器SAML 2.0协议详解<a hidden class=anchor aria-hidden=true href=#第16篇企业级sso的利器saml-20协议详解>#</a></h2><p>在上一篇文章中，我们深入探讨了OpenID Connect (OIDC) 如何在OAuth 2.0之上构建身份认证层，成为现代互联网和移动应用SSO的主流选择。然而，在企业级应用和组织间协作的场景中，尤其是一些传统或遗留系统，你可能更常听到另一个强大的SSO协议——<strong>SAML 2.0 (Security Assertion Markup Language)</strong>。</p><p>SAML 2.0是基于XML的开放标准，专门用于在不同安全域之间安全地交换认证和授权数据。它在企业级SSO领域扮演着举足轻重的角色，是许多大型企业内部应用以及企业与云服务（如Salesforce、Microsoft 365等）进行身份联邦的基石。</p><h3 id=1-saml-20的核心概念信任的桥梁>1. SAML 2.0的核心概念：信任的桥梁<a hidden class=anchor aria-hidden=true href=#1-saml-20的核心概念信任的桥梁>#</a></h3><p>SAML 2.0的核心在于构建一个<strong>信任联盟（Trust Federation）</strong>，允许用户在一个信任域（通常是企业内部）完成认证后，无需重复登录即可访问另一个信任域（例如，一个外部SaaS应用）的资源。理解其核心概念是掌握SAML的关键。</p><h4 id=11-身份提供者identity-provider-idp>1.1 身份提供者（Identity Provider, IdP）<a hidden class=anchor aria-hidden=true href=#11-身份提供者identity-provider-idp>#</a></h4><ul><li><strong>定义：</strong> IdP是负责<strong>认证用户身份</strong>并<strong>生成SAML断言</strong>的实体。它就像一个“数字护照签发机构”。</li><li><strong>职责：</strong><ul><li>接收用户的认证请求（例如，登录页面的用户名密码）。</li><li>验证用户凭证。</li><li>成功认证后，生成一个包含用户身份和属性信息的SAML断言（Assertion），并对其进行数字签名。</li><li>将SAML断言发送给服务提供者（SP）。</li></ul></li><li><strong>常见示例：</strong> 企业内部的Active Directory Federation Services (AD FS)、Okta、PingFederate、Azure AD等。</li></ul><h4 id=12-服务提供者service-provider-sp>1.2 服务提供者（Service Provider, SP）<a hidden class=anchor aria-hidden=true href=#12-服务提供者service-provider-sp>#</a></h4><ul><li><strong>定义：</strong> SP是提供具体应用服务并依赖IdP进行用户认证的实体。它就像一个“边境检查站”，接收并验证数字护照。</li><li><strong>职责：</strong><ul><li>接收用户的访问请求。</li><li>检测用户是否已认证。如果未认证，将用户重定向到IdP。</li><li>接收来自IdP的SAML断言。</li><li>验证SAML断言的有效性（包括签名、时间戳、受众等）。</li><li>根据断言中的用户身份信息，创建本地会话并允许用户访问应用。</li></ul></li><li><strong>常见示例：</strong> Salesforce、Microsoft 365、Workday、各种企业内部Web应用。</li></ul><h4 id=13-saml-断言saml-assertion>1.3 SAML 断言（SAML Assertion）<a hidden class=anchor aria-hidden=true href=#13-saml-断言saml-assertion>#</a></h4><ul><li><strong>定义：</strong> SAML断言是SAML协议的核心，它是一个XML文档，包含了由IdP生成的关于用户身份和认证事件的声明（Statements）。它就像一份数字化的“身份证明”或“通行证”。</li><li><strong>核心信息：</strong><ul><li><strong>认证声明（Authentication Statement）：</strong> 声明了用户何时、何地以及如何被IdP认证。</li><li><strong>属性声明（Attribute Statement）：</strong> 包含了用户的各种属性信息（Attributes），如姓名、邮箱、部门、角色等。这些属性可以用于SP进行授权决策或填充用户档案。</li><li><strong>授权决策声明（Authorization Decision Statement）：</strong> 较少使用，可用于声明IdP对特定资源或操作的授权决策。</li></ul></li><li><strong>安全性：</strong> SAML断言必须由IdP进行<strong>数字签名</strong>，以确保其完整性和真实性，防止篡改。SP会使用IdP的公共证书来验证此签名。断言通常也会被加密传输。</li></ul><h3 id=2-saml-20的两种主要工作流程>2. SAML 2.0的两种主要工作流程<a hidden class=anchor aria-hidden=true href=#2-saml-20的两种主要工作流程>#</a></h3><p>SAML 2.0主要定义了两种用户启动SSO的流程，它们决定了用户在未登录时首先访问哪一方。</p><h4 id=21-sp-initiated-sso服务提供者发起>2.1 SP-Initiated SSO（服务提供者发起）<a hidden class=anchor aria-hidden=true href=#21-sp-initiated-sso服务提供者发起>#</a></h4><p>这是最常见的SAML SSO流程，用户通常从尝试访问某个SP的应用开始。</p><ol><li><strong>用户尝试访问SP资源：</strong> 用户通过浏览器访问SP上的一个受保护资源。</li><li><strong>SP发起认证请求：</strong> SP发现用户未登录，生成一个SAML认证请求（<code>AuthnRequest</code>，XML格式），并将其编码后（通常是Base64编码）通过HTTP重定向（GET）或HTTP POST（表单提交）方式，将用户浏览器重定向到IdP的SSO端点，请求用户认证。<ul><li><strong>HTTP Redirect Binding：</strong> <code>AuthnRequest</code>被压缩、Base64编码后放入URL参数。适用于较小的请求。</li><li><strong>HTTP POST Binding：</strong> <code>AuthnRequest</code>被Base64编码后放入一个HTML表单的隐藏字段，表单自动提交到IdP。</li></ul></li><li><strong>用户在IdP认证：</strong> 用户浏览器被重定向到IdP的登录页面。用户在此处输入凭证（用户名/密码，可能还有MFA）进行认证。</li><li><strong>IdP生成并返回SAML响应：</strong> IdP验证用户凭证成功后，生成一个包含认证信息和用户属性的SAML响应（<code>Response</code>，XML格式，内含SAML断言），并对其进行数字签名。然后，IdP将这个SAML响应编码后（通常是Base64编码）通过HTTP POST（自动提交的HTML表单）方式，将用户浏览器重定向回SP的Assertion Consumer Service (ACS) 端点。</li><li><strong>SP验证SAML响应并建立会话：</strong> SP的ACS端点接收SAML响应，验证其数字签名、断言的有效性（如时间戳、受众等），并从断言中提取用户身份和属性信息。</li><li><strong>SP授予访问权限：</strong> SP根据验证通过的SAML断言为用户创建本地会话，并允许用户访问请求的资源。</li></ol><pre tabindex=0><code class=language-mermaid data-lang=mermaid>sequenceDiagram
    participant User
    participant SP
    participant IdP

    User-&gt;&gt;SP: 1. 尝试访问受保护资源
    SP-&gt;&gt;User: 2. 发起认证请求 (HTTP Redirect/POST with AuthnRequest)
    User-&gt;&gt;IdP: 2. 浏览器重定向到IdP SSO端点
    activate IdP
    IdP--&gt;&gt;User: 3. 显示登录页面
    User-&gt;&gt;IdP: 3. 输入凭证并认证
    deactivate IdP
    IdP-&gt;&gt;User: 4. 返回SAML响应 (HTTP POST with SAMLResponse)
    User-&gt;&gt;SP: 4. 浏览器重定向到SP ACS端点
    activate SP
    SP-&gt;&gt;SP: 5. 验证SAML响应并建立会话
    SP--&gt;&gt;User: 6. 授予访问权限，访问请求资源
    deactivate SP
</code></pre><h4 id=22-idp-initiated-sso身份提供者发起>2.2 IdP-Initiated SSO（身份提供者发起）<a hidden class=anchor aria-hidden=true href=#22-idp-initiated-sso身份提供者发起>#</a></h4><p>这种流程相对简单，用户通常从IdP的门户网站登录开始。</p><ol><li><strong>用户在IdP门户登录：</strong> 用户直接访问IdP的门户（例如，企业内部员工门户）并在此处登录。</li><li><strong>IdP生成并发送SAML响应：</strong> IdP认证用户成功后，用户可以选择访问某个已集成的SP应用。IdP会立即生成一个包含用户身份和属性信息的SAML响应（<code>Response</code>，XML格式，内含SAML断言），并对其进行数字签名。然后，IdP将这个SAML响应编码后（通常是Base64编码）通过HTTP POST方式，将用户浏览器重定向到指定SP的ACS端点。</li><li><strong>SP验证SAML响应并建立会话：</strong> SP的ACS端点接收SAML响应，验证其有效性并提取用户信息。</li><li><strong>SP授予访问权限：</strong> SP根据验证通过的SAML断言为用户创建本地会话，并允许用户访问应用。</li></ol><pre tabindex=0><code class=language-mermaid data-lang=mermaid>sequenceDiagram
    participant User
    participant IdP
    participant SP

    User-&gt;&gt;IdP: 1. 访问IdP门户并登录
    activate IdP
    IdP--&gt;&gt;User: 1. 显示已认证的IdP门户
    User-&gt;&gt;IdP: 2. 选择访问某个SP应用
    IdP-&gt;&gt;User: 2. 生成并发送SAML响应 (HTTP POST with SAMLResponse)
    deactivate IdP
    User-&gt;&gt;SP: 2. 浏览器重定向到SP ACS端点
    activate SP
    SP-&gt;&gt;SP: 3. 验证SAML响应并建立会话
    SP--&gt;&gt;User: 4. 授予访问权限，访问应用
    deactivate SP
</code></pre><ul><li><strong>对比：</strong> SP-Initiated SSO更常见，因为它允许用户从任何一个SP应用启动登录，用户体验更自然。IdP-Initiated SSO则适合从企业内部统一门户访问所有应用的场景。</li></ul><h3 id=3-saml-20的绑定bindings传输saml消息的方式>3. SAML 2.0的绑定（Bindings）：传输SAML消息的方式<a hidden class=anchor aria-hidden=true href=#3-saml-20的绑定bindings传输saml消息的方式>#</a></h3><p>SAML 2.0定义了多种“绑定”（Bindings），它们描述了SAML消息（如<code>AuthnRequest</code>和<code>Response</code>）如何在不同的传输协议（如HTTP）上进行交换。最常用的两种是：</p><h4 id=31-http-redirect-binding>3.1 HTTP Redirect Binding<a hidden class=anchor aria-hidden=true href=#31-http-redirect-binding>#</a></h4><ul><li><strong>原理：</strong> SAML消息（如<code>AuthnRequest</code>）会被压缩并进行Base64编码，然后作为URL查询参数附加到HTTP重定向（GET请求）中。</li><li><strong>特点：</strong><ul><li>简单，广泛支持。</li><li>URL长度有限制，不适合传输大的SAML消息。</li><li>消息内容暴露在URL中（尽管编码了，但并非加密），不适合传输敏感信息。</li></ul></li><li><strong>适用场景：</strong> 通常用于SP向IdP发送<code>AuthnRequest</code>，因为请求通常较小。</li></ul><h4 id=32-http-post-binding>3.2 HTTP POST Binding<a hidden class=anchor aria-hidden=true href=#32-http-post-binding>#</a></h4><ul><li><strong>原理：</strong> SAML消息会被Base64编码，然后作为隐藏的表单字段（<code>SAMLRequest</code>或<code>SAMLResponse</code>）放置在一个HTML表单中，并通过HTTP POST方法自动提交到目标URL。</li><li><strong>特点：</strong><ul><li>没有URL长度限制，可以传输更大的SAML消息。</li><li>消息内容不会直接暴露在URL中。</li><li>是SAML响应（<code>Response</code>）最常用的传输方式，因为它包含敏感的认证断言。</li></ul></li><li><strong>适用场景：</strong> IdP向SP发送<code>SAMLResponse</code>，以及一些SP发送<code>AuthnRequest</code>的场景。</li></ul><p><strong>除了上述两种，还有SOAP Binding（通过SOAP协议传输）等，但HTTP POST和HTTP Redirect是最普遍使用的。</strong> 所有的SAML通信都应该在<strong>HTTPS/TLS</strong>加密通道上进行，以保护传输中的敏感数据。</p><h3 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h3><p>SAML 2.0作为一个成熟且广泛采纳的企业级SSO协议，通过定义IdP、SP和SAML断言等核心概念，以及SP-Initiated和IdP-Initiated两种主要工作流程，实现了不同安全域之间的身份联邦。其基于XML和数字签名的特性，使其在安全性和互操作性方面表现出色，成为连接企业内部系统与外部云服务的强大工具。</p><p>尽管其配置和实现可能比OIDC更为复杂，但SAML 2.0在传统企业和大型组织架构中仍然扮演着不可替代的角色。理解SAML 2.0的工作原理和最佳实践，是构建复杂IAM和身份联邦解决方案的关键能力。</p><h3></h3><p><strong>欢迎关注+点赞+推荐+转发</strong></p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://bsong2015.github.io/blog/>万年水的博客</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>